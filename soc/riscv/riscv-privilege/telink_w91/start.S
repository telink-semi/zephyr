/*
 * Copyright (c) 2023 Telink Semiconductor
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <soc.h>
#include <zephyr/devicetree.h>
#include <zephyr/toolchain.h>

#define N22_CORE_START (DT_REG_ADDR(DT_CHOSEN(zephyr_flash)) + DT_REG_SIZE(DT_CHOSEN(zephyr_flash)))

	.option push
	.option norelax

SECTION_FUNC(init, init)
	.org 0x0

	.global reset_vector

reset_vector:
	.global _start
	.type _start,@function

	.word (0x31707848)	               #/ magic
	.word (0x33e90d91)                 #/ header crc32
	.org 0x14
	.word (0xa0000080)                 #/ start address

	.org 0xa0
_start:                                #/ after reset starts on D25 core

	lui    t0, 0xf0100
	lui	   t1, %hi(N22_CORE_START)
	addi   t1, t1, %lo(N22_CORE_START)
	sw     t1, 0x204(t0)               #/ N22 core address: 0xf0100204 <- N22_CORE_START
	lui    t0, 0xf1700
	li     t1, 0x10
	sw     t1, 0x218(t0)               #/ N22 core reset: 0xf1700218 <- 0x10

	csrw   mie, zero                   #/ disable interrupts
	li     t0, (1 << 3)
	csrc   mstatus, t0                 #/ Clear Machine Status
	csrw   mepc, zero                  #/ Clear Machine Exception PC
	li     t0, (3 << 6)
	csrc   NDS_MXSTATUS, t0            #/ Clear Machine Extended Status

	li     t0, 0x1
	csrs   NDS_MCACHE_CTL, t0          #/ enable I-Cache
	li     t0, 0x2
	csrs   NDS_MCACHE_CTL, t0          #/ enable I-Cache
	li     t0, (1 << 6)
	csrs   NDS_MMISC_CTL, t0           #/ Enable Misaligned access

	call   __start                     #/ jump to kernel entry
1:	j      1b

	.option pop
